{% extends "base.html" %}

{% block title %}Dashboard - NSW Fuel Monitor{% endblock %}

{% block content %}
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-1">
                <i class="bi bi-speedometer2"></i>
                Dashboard
            </h1>
            <p class="text-secondary mb-0">Current fuel prices and trends</p>
        </div>
        <div class="col-auto">
            <button class="btn btn-primary" onclick="refreshPrices()">
                <i class="bi bi-arrow-clockwise"></i>
                Refresh
            </button>
        </div>
    </div>
    
    <!-- Current Prices -->
    <div class="row" id="pricesContainer">
        <div class="col-12 text-center py-5">
            <div class="loading-spinner" style="width: 3rem; height: 3rem; border-width: 4px;"></div>
            <p class="text-secondary mt-3">Loading fuel prices...</p>
        </div>
    </div>
    
    <!-- Price Charts -->
    <div class="row mt-4" id="chartsContainer" style="display: none;">
        <div class="col-12">
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-graph-up"></i> Price Trends</span>
                    <div>
                        <select class="form-select form-select-sm d-inline-block w-auto" id="chartStation">
                            <option value="">All Stations</option>
                        </select>
                        <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="chartFuelType">
                            <option value="">All Fuel Types</option>
                        </select>
                        <select class="form-select form-select-sm d-inline-block w-auto ms-2" id="chartDays">
                            <option value="1">Last 24 hours</option>
                            <option value="7" selected>Last 7 days</option>
                            <option value="30">Last 30 days</option>
                            <option value="90">Last 90 days</option>
                        </select>
                    </div>
                </div>
                <div class="card-body">
                    <div style="position: relative; min-height: 300px;">
                        <canvas id="priceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Price History Modal -->
    <div class="modal fade" id="priceHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="priceHistoryModalLabel">Price History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-center mb-3">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="historyDays" id="days7" value="7" checked onchange="updateModalChart()">
                            <label class="btn btn-outline-primary" for="days7">7 Days</label>

                            <input type="radio" class="btn-check" name="historyDays" id="days14" value="14" onchange="updateModalChart()">
                            <label class="btn btn-outline-primary" for="days14">14 Days</label>

                            <input type="radio" class="btn-check" name="historyDays" id="days28" value="28" onchange="updateModalChart()">
                            <label class="btn btn-outline-primary" for="days28">28 Days</label>

                            <input type="radio" class="btn-check" name="historyDays" id="days90" value="90" onchange="updateModalChart()">
                            <label class="btn btn-outline-primary" for="days90">90 Days</label>
                        </div>
                    </div>
                    <div style="position: relative; height: 400px; width: 100%;">
                        <canvas id="modalPriceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Station Price History Modal -->
    <div class="modal fade" id="stationPriceHistoryModal" tabindex="-1">
        <div class="modal-dialog modal-lg">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="stationPriceHistoryModalLabel">Price History</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="d-flex justify-content-center mb-3">
                        <div class="btn-group" role="group">
                            <input type="radio" class="btn-check" name="stationHistoryDays" id="stationDays7" value="7" checked onchange="updateStationModalChart()">
                            <label class="btn btn-outline-primary" for="stationDays7">7 Days</label>

                            <input type="radio" class="btn-check" name="stationHistoryDays" id="stationDays14" value="14" onchange="updateStationModalChart()">
                            <label class="btn btn-outline-primary" for="stationDays14">14 Days</label>

                            <input type="radio" class="btn-check" name="stationHistoryDays" id="stationDays28" value="28" onchange="updateStationModalChart()">
                            <label class="btn btn-outline-primary" for="stationDays28">28 Days</label>

                            <input type="radio" class="btn-check" name="stationHistoryDays" id="stationDays90" value="90" onchange="updateStationModalChart()">
                            <label class="btn btn-outline-primary" for="stationDays90">90 Days</label>
                        </div>
                    </div>
                    <div style="position: relative; height: 400px; width: 100%;">
                        <canvas id="stationModalPriceChart"></canvas>
                    </div>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    let priceChart = null;
    let stationsData = [];
    
    // Modal related variables
    let modalChart = null;
    let currentModalStationId = null;
    let currentModalFuelType = null;
    let priceHistoryModal = null;
    
    // Station Modal related variables
    let stationPriceHistoryModal = null;
    let stationModalChart = null;
    let currentStationModalId = null;
    
    // Helper function to escape HTML to prevent XSS
    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }
    
    // Load current prices on page load
    document.addEventListener('DOMContentLoaded', function() {
        loadCurrentPrices();
        priceHistoryModal = new bootstrap.Modal(document.getElementById('priceHistoryModal'));
        stationPriceHistoryModal = new bootstrap.Modal(document.getElementById('stationPriceHistoryModal'));
    });

    function openStationHistoryModal(stationId, stationName) {
        currentStationModalId = stationId;
        
        document.getElementById('stationPriceHistoryModalLabel').textContent = `${stationName} - Price History`;
        
        // Reset to 7 days
        document.getElementById('stationDays7').checked = true;
        
        stationPriceHistoryModal.show();
        updateStationModalChart();
    }

    async function updateStationModalChart() {
        if (!currentStationModalId) return;
        
        const days = document.querySelector('input[name="stationHistoryDays"]:checked').value;
        
        try {
            // Fetch history for ALL fuel types for this station
            const url = `/api/prices/history?days=${days}&station_id=${currentStationModalId}`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (!response.ok) throw new Error(data.error || 'Failed to load history');
            
            displayStationModalChart(data.history);
        } catch (error) {
            console.error('Error loading modal history:', error);
        }
    }

    function displayStationModalChart(history) {
        const ctx = document.getElementById('stationModalPriceChart').getContext('2d');
        
        if (stationModalChart) {
            stationModalChart.destroy();
        }

        // Group data by fuel_type
        const groups = {};
        
        history.forEach(item => {
            const key = item.fuel_type;
            if (!groups[key]) {
                groups[key] = {
                    label: item.fuel_type,
                    data: []
                };
            }
            groups[key].data.push({
                x: new Date(item.time),
                y: item.price
            });
        });

        const colors = [
            'rgb(59, 130, 246)', 'rgb(239, 68, 68)', 'rgb(34, 197, 94)',
            'rgb(245, 158, 11)', 'rgb(168, 85, 247)', 'rgb(236, 72, 153)',
            'rgb(20, 184, 166)', 'rgb(249, 115, 22)'
        ];

        const datasets = Object.values(groups).map((group, index) => ({
            label: group.label,
            data: group.data,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length].replace('rgb', 'rgba').replace(')', ', 0.1)'),
            borderWidth: 2,
            tension: 0.4,
            fill: false
        }));

        stationModalChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: { display: true },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}¢`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: { day: 'MMM d' }
                        },
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        display: true,
                        grid: { color: '#334155' },
                        ticks: {
                            color: '#94a3b8',
                            callback: value => value.toFixed(1) + '¢'
                        }
                    }
                }
            }
        });
    }
    
    function openPriceHistoryModal(stationId, stationName, fuelType) {
        currentModalStationId = stationId;
        currentModalFuelType = fuelType;
        
        document.getElementById('priceHistoryModalLabel').textContent = `${stationName} - ${fuelType}`;
        
        // Reset to 7 days
        document.getElementById('days7').checked = true;
        
        priceHistoryModal.show();
        updateModalChart();
    }

    async function updateModalChart() {
        if (!currentModalStationId || !currentModalFuelType) return;
        
        const days = document.querySelector('input[name="historyDays"]:checked').value;
        
        try {
            const url = `/api/prices/history?days=${days}&station_id=${currentModalStationId}&fuel_type=${currentModalFuelType}`;
            const response = await fetch(url);
            const data = await response.json();
            
            if (!response.ok) throw new Error(data.error || 'Failed to load history');
            
            displayModalChart(data.history, currentModalFuelType);
        } catch (error) {
            console.error('Error loading modal history:', error);
        }
    }

    function displayModalChart(history, fuelType) {
        const ctx = document.getElementById('modalPriceChart').getContext('2d');
        
        if (modalChart) {
            modalChart.destroy();
        }

        const dataPoints = history.map(item => ({
            x: new Date(item.time),
            y: item.price
        }));

        modalChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: [{
                    label: `${fuelType} Price`,
                    data: dataPoints,
                    borderColor: 'rgb(59, 130, 246)',
                    backgroundColor: 'rgba(59, 130, 246, 0.1)',
                    borderWidth: 2,
                    tension: 0.4,
                    fill: true
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.parsed.y.toFixed(1)}¢`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: { day: 'MMM d' }
                        },
                        grid: { color: '#334155' },
                        ticks: { color: '#94a3b8' }
                    },
                    y: {
                        display: true,
                        grid: { color: '#334155' },
                        ticks: {
                            color: '#94a3b8',
                            callback: value => value.toFixed(1) + '¢'
                        }
                    }
                }
            }
        });
    }

    async function loadCurrentPrices() {
        try {
            const response = await fetch('/api/prices/current');
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to load prices');
            }
            
            stationsData = data.prices;
            displayPrices(data.prices);
            populateChartFilters(data.prices);
        } catch (error) {
            console.error('Error loading prices:', error);
            document.getElementById('pricesContainer').innerHTML = `
                <div class="col-12">
                    <div class="alert alert-danger">
                        <i class="bi bi-exclamation-triangle-fill me-2"></i>
                        Failed to load fuel prices
                    </div>
                </div>
            `;
        }
    }
    
    function displayPrices(prices) {
        const container = document.getElementById('pricesContainer');
        
        if (prices.length === 0) {
            container.innerHTML = `
                <div class="col-12">
                    <div class="alert alert-warning">
                        <i class="bi bi-info-circle-fill me-2"></i>
                        No stations configured. Go to <a href="/stations" class="alert-link">Stations</a> to add some.
                    </div>
                </div>
            `;
            return;
        }
        
        let html = '';
        
        for (const station of prices) {
            html += `
                <div class="col-12 mb-4">
                    <div class="card">
                        <div class="card-header">
                            <div class="station-name">
                                <a href="javascript:void(0)" class="text-decoration-none text-white" 
                                   onclick="openStationHistoryModal('${station.station_id}', '${escapeHtml(station.station_name).replace(/'/g, "\\'")}')">
                                    ${escapeHtml(station.station_name)}
                                </a>
                            </div>
                            <div class="station-address">${escapeHtml(station.station_address)}</div>
                        </div>
                        <div class="card-body">
                            <div class="row g-3">
            `;
            
            const fuelTypes = Object.keys(station.prices);
            if (fuelTypes.length === 0) {
                html += `
                    <div class="col-12">
                        <p class="text-secondary mb-0">No prices available</p>
                    </div>
                `;
            } else {
                for (const fuelType in station.prices) {
                    const price = station.prices[fuelType];
                    const priceInCents = price.toFixed(1);
                    const trend = station.trends ? station.trends[fuelType] : 'unknown';
                    
                    let trendIcon = '';
                    if (trend === 'up') {
                        trendIcon = '<i class="bi bi-caret-up-fill text-danger ms-1"></i>';
                    } else if (trend === 'down') {
                        trendIcon = '<i class="bi bi-caret-down-fill text-success ms-1"></i>';
                    } else if (trend === 'stable') {
                        trendIcon = '<i class="bi bi-dash-lg text-secondary ms-1"></i>';
                    }

                    const lastUpdatedISO = station.last_updated ? station.last_updated[fuelType] : null;
                    let lastUpdatedStr = '';
                    if (lastUpdatedISO) {
                        try {
                            const date = new Date(lastUpdatedISO);
                            if (!isNaN(date.getTime())) {
                                if (window.dateFns) {
                                    const distance = dateFns.formatDistanceToNow(date, { addSuffix: true });
                                    lastUpdatedStr = `<div class="text-secondary small mt-1" style="font-size: 0.65rem;">Updated ${distance}</div>`;
                                } else {
                                    console.warn('dateFns not found, falling back to simple string');
                                    // Fallback if date-fns not loaded
                                    const dateStr = date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], {hour: '2-digit', minute:'2-digit'});
                                    lastUpdatedStr = `<div class="text-secondary small mt-1" style="font-size: 0.65rem;">Updated ${dateStr}</div>`;
                                }
                            }
                        } catch (e) {
                            console.error('Date parsing error', e);
                        }
                    }

                    html += `
                        <div class="col-md-3 col-sm-4 col-6">
                            <div class="price-card h-100" style="cursor: pointer; transition: transform 0.2s;" 
                                 onclick="openPriceHistoryModal('${station.station_id}', '${escapeHtml(station.station_name).replace(/'/g, "\\'")}', '${fuelType}')"
                                 onmouseover="this.style.transform='scale(1.05)'" 
                                 onmouseout="this.style.transform='scale(1)'">
                                <div class="price-label">${escapeHtml(fuelType)}</div>
                                <div class="price-value">${priceInCents}¢${trendIcon}</div>
                                ${lastUpdatedStr}
                            </div>
                        </div>
                    `;
                }
            }
            
            html += `
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }
        
        container.innerHTML = html;
        
        // Show charts section if we have data
        document.getElementById('chartsContainer').style.display = 'block';
    }
    
    function populateChartFilters(prices) {
        const stationSelect = document.getElementById('chartStation');
        const fuelTypeSelect = document.getElementById('chartFuelType');
        
        // Clear existing options but keep "All"
        stationSelect.innerHTML = '<option value="">All Stations</option>';
        
        // Populate stations
        for (const station of prices) {
            const option = document.createElement('option');
            option.value = station.station_id;
            option.textContent = station.station_name;
            stationSelect.appendChild(option);
        }
        
        // Add event listeners
        stationSelect.addEventListener('change', updateFuelTypeOptions);
        fuelTypeSelect.addEventListener('change', loadPriceHistory);
        document.getElementById('chartDays').addEventListener('change', loadPriceHistory);
        
        updateFuelTypeOptions();
    }
    
    function updateFuelTypeOptions() {
        const stationSelect = document.getElementById('chartStation');
        const fuelTypeSelect = document.getElementById('chartFuelType');
        const selectedStationId = stationSelect.value;
        const currentSelection = fuelTypeSelect.value;
        
        // Remove "All Fuel Types" option by not adding it initially
        fuelTypeSelect.innerHTML = ''; 
        // Or keep it but make it not default? User said "just have 1 fuel type selected"
        // Let's keep "All Fuel Types" as an option but select P98 by default.
        const allOption = document.createElement('option');
        allOption.value = "";
        allOption.textContent = "All Fuel Types";
        fuelTypeSelect.appendChild(allOption);
        
        let fuelTypes = new Set();
        if (selectedStationId === "") {
            // All stations - collect all unique fuel types
            stationsData.forEach(s => {
                Object.keys(s.prices).forEach(ft => fuelTypes.add(ft));
            });
        } else {
            const station = stationsData.find(s => s.station_id == selectedStationId);
            if (station) {
                Object.keys(station.prices).forEach(ft => fuelTypes.add(ft));
            }
        }

        const sortedTypes = Array.from(fuelTypes).sort();
        sortedTypes.forEach(fuelType => {
            const option = document.createElement('option');
            option.value = fuelType;
            option.textContent = fuelType;
            fuelTypeSelect.appendChild(option);
        });
        
        // Select P98 by default if available and no current selection (or "All" was selected),
        // otherwise select the first available type.
        // If user manually selected a type, try to keep it.
        if (currentSelection && fuelTypes.has(currentSelection)) {
            fuelTypeSelect.value = currentSelection;
        } else {
            if (fuelTypes.has("P98")) {
                fuelTypeSelect.value = "P98";
            } else if (sortedTypes.length > 0) {
                fuelTypeSelect.value = sortedTypes[0];
            } else {
                fuelTypeSelect.value = ""; // Fallback to All
            }
        }
        
        loadPriceHistory();
    }
    
    async function loadPriceHistory() {
        const stationId = document.getElementById('chartStation').value;
        const fuelType = document.getElementById('chartFuelType').value;
        const days = document.getElementById('chartDays').value;
        
        try {
            let url = `/api/prices/history?days=${days}`;
            if (stationId) url += `&station_id=${stationId}`;
            if (fuelType) url += `&fuel_type=${fuelType}`;

            const response = await fetch(url);
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to load price history');
            }
            
            displayPriceChart(data.history, fuelType);
        } catch (error) {
            console.error('Error loading price history:', error);
            showToast('Failed to load price history', 'error');
        }
    }
    
    function displayPriceChart(history, selectedFuelType) {
        const ctx = document.getElementById('priceChart').getContext('2d');
        
        if (priceChart) {
            priceChart.destroy();
        }
        
        // Group data by station_id and fuel_type
        const groups = {};
        const timestamps = new Set();
        
        history.forEach(item => {
            const key = `${item.station_id}_${item.fuel_type}`;
            if (!groups[key]) {
                const station = stationsData.find(s => s.station_id == item.station_id);
                groups[key] = {
                    label: station ? `${station.station_name} - ${item.fuel_type}` : `${item.station_id} - ${item.fuel_type}`,
                    data: []
                };
            }
            groups[key].data.push({
                x: new Date(item.time),
                y: item.price
            });
        });

        const colors = [
            'rgb(59, 130, 246)', 'rgb(239, 68, 68)', 'rgb(34, 197, 94)',
            'rgb(245, 158, 11)', 'rgb(168, 85, 247)', 'rgb(236, 72, 153)',
            'rgb(20, 184, 166)', 'rgb(249, 115, 22)'
        ];
        
        const datasets = Object.values(groups).map((group, index) => ({
            label: group.label,
            data: group.data,
            borderColor: colors[index % colors.length],
            backgroundColor: colors[index % colors.length].replace('rgb', 'rgba').replace(')', ', 0.1)'),
            borderWidth: 2,
            tension: 0.4,
            fill: false
        }));
        
        priceChart = new Chart(ctx, {
            type: 'line',
            data: {
                datasets: datasets
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                interaction: {
                    mode: 'index',
                    intersect: false
                },
                plugins: {
                    legend: {
                        display: true,
                        position: 'bottom',
                        labels: {
                            color: '#f1f5f9',
                            boxWidth: 12,
                            padding: 15
                        }
                    },
                    tooltip: {
                        callbacks: {
                            label: function(context) {
                                return `${context.dataset.label}: ${context.parsed.y.toFixed(1)}¢`;
                            }
                        }
                    }
                },
                scales: {
                    x: {
                        type: 'time',
                        time: {
                            unit: 'day',
                            displayFormats: {
                                day: 'MMM d'
                            }
                        },
                        grid: {
                            color: '#334155'
                        },
                        ticks: {
                            color: '#94a3b8'
                        }
                    },
                    y: {
                        display: true,
                        grid: {
                            color: '#334155'
                        },
                        ticks: {
                            color: '#94a3b8',
                            callback: function(value) {
                                return value.toFixed(1) + '¢';
                            }
                        }
                    }
                }
            }
        });
    }
    
    function refreshPrices() {
        document.getElementById('pricesContainer').innerHTML = `
            <div class="col-12 text-center py-5">
                <div class="loading-spinner" style="width: 3rem; height: 3rem; border-width: 4px;"></div>
                <p class="text-secondary mt-3">Loading fuel prices...</p>
            </div>
        `;
        loadCurrentPrices();
    }
</script>
{% endblock %}
