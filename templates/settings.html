{% extends "base.html" %}

{% block title %}Settings - NSW Fuel Monitor{% endblock %}

{% block content %}
    <div class="row mb-4">
        <div class="col">
            <h1 class="h2 mb-1">
                <i class="bi bi-gear-fill"></i>
                Settings
            </h1>
            <p class="text-secondary mb-0">Configuration and system information</p>
        </div>
    </div>
    
    <!-- Configuration -->
    <div class="row">
        <!-- Left Column -->
        <div class="col-lg-6">
            <!-- Application Settings -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-sliders"></i> Application Settings</span>
                    <button class="btn btn-sm btn-primary" id="editAppBtn" onclick="editAppSettings()">
                        <i class="bi bi-pencil-fill"></i> Edit
                    </button>
                </div>
                <div class="card-body">
                    <div id="appSettingsContainer">
                        <div class="text-center py-5">
                            <div class="loading-spinner" style="width: 3rem; height: 3rem; border-width: 4px;"></div>
                            <p class="text-secondary mt-3">Loading settings...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- InfluxDB Configuration -->
            <div class="card mt-4">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-database-fill"></i> InfluxDB Configuration</span>
                    <button class="btn btn-sm btn-primary" id="editInfluxBtn" onclick="editInfluxConfig()">
                        <i class="bi bi-pencil-fill"></i> Edit
                    </button>
                </div>
                <div class="card-body">
                    <div id="configContainer">
                        <div class="text-center py-5">
                            <div class="loading-spinner" style="width: 3rem; height: 3rem; border-width: 4px;"></div>
                            <p class="text-secondary mt-3">Loading configuration...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Backup & Restore -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-archive-fill"></i>
                    Backup & Restore
                </div>
                <div class="card-body">
                    <p class="small text-secondary">
                        Create a full backup of your InfluxDB data or restore from a previous backup.
                    </p>
                    <div class="d-flex gap-2">
                        <button class="btn btn-outline-primary" onclick="createBackup()" id="backupBtn">
                            <i class="bi bi-download"></i> Download Backup
                        </button>
                        <button class="btn btn-outline-danger" onclick="document.getElementById('restoreFile').click()" id="restoreBtn">
                            <i class="bi bi-upload"></i> Restore Backup
                        </button>
                        <input type="file" id="restoreFile" accept=".zip" style="display: none" onchange="restoreBackup(this)">
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Right Column -->
        <div class="col-lg-6">
            <!-- Home Assistant (MQTT) -->
            <div class="card">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span><i class="bi bi-broadcast"></i> Home Assistant (MQTT)</span>
                    <button class="btn btn-sm btn-primary" id="editMqttBtn" onclick="editMqttConfig()">
                        <i class="bi bi-pencil-fill"></i> Edit
                    </button>
                </div>
                <div class="card-body">
                    <div id="mqttConfigContainer">
                        <div class="text-center py-5">
                            <div class="loading-spinner" style="width: 3rem; height: 3rem; border-width: 4px;"></div>
                            <p class="text-secondary mt-3">Loading settings...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- HA Card Generator -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-code-square"></i>
                    Home Assistant Card Generator
                </div>
                <div class="card-body">
                    <p class="small text-secondary">
                        Generate Lovelace YAML for a ranked fuel price card. Requires 
                        <a href="https://github.com/piitaya/lovelace-mushroom" target="_blank">Mushroom Cards</a>, 
                        <a href="https://github.com/thomasloven/lovelace-auto-entities" target="_blank">Auto Entities</a>, and
                        <a href="https://github.com/thomasloven/lovelace-card-mod" target="_blank">Card Mod</a>.
                    </p>
                    <div class="input-group mb-3">
                        <select class="form-select" id="haFuelType">
                            <option value="P98" selected>P98</option>
                            <option value="P95">P95</option>
                            <option value="U91">U91</option>
                            <option value="E10">E10</option>
                            <option value="DL">DL</option>
                            <option value="LPG">LPG</option>
                        </select>
                        <button class="btn btn-primary" type="button" onclick="generateHACard()">Generate YAML</button>
                    </div>
                    <div id="haCardResult" style="display: none;">
                        <textarea class="form-control font-monospace small" id="haCardOutput" rows="10" readonly style="background-color: #0f172a; color: #f8f9fa; border: 1px solid #334155;"></textarea>
                        <button class="btn btn-outline-secondary btn-sm mt-2 w-100" onclick="copyHACard()">
                            <i class="bi bi-clipboard"></i> Copy to Clipboard
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- System Information -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-info-circle-fill"></i>
                    System Information
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <span class="config-label">Application</span>
                        <div class="config-value">NSW Fuel Station Monitor</div>
                    </div>
                    <div class="mb-3">
                        <span class="config-label">Data Source</span>
                        <div class="config-value">NSW FuelCheck API</div>
                    </div>
                    <div class="mb-3">
                        <span class="config-label">Configuration Storage</span>
                        <div class="config-value">SQLite Database</div>
                    </div>
                    <div class="mb-3">
                        <span class="config-label">Documentation</span>
                        <div class="config-value">
                            <a href="https://github.com/m1ckyb/FuelApp" target="_blank" class="text-decoration-none">
                                <i class="bi bi-github"></i> GitHub Repository
                            </a>
                        </div>
                    </div>
                </div>
            </div>
            
            <!-- About -->
            <div class="card mt-4">
                <div class="card-header">
                    <i class="bi bi-shield-check"></i>
                    About FuelCheck
                </div>
                <div class="card-body">
                    <p class="small text-secondary mb-0">
                        Data provided by NSW Government FuelCheck. This application is not officially 
                        affiliated with or endorsed by NSW Government or FuelCheck. 
                        <br><br>
                        Prices are updated based on your configured polling interval and stored in InfluxDB 
                        for historical analysis.
                    </p>
                </div>
            </div>
        </div>
    </div>
{% endblock %}

{% block extra_js %}
<script>
    let currentConfig = null;
    
    document.addEventListener('DOMContentLoaded', function() {
        loadConfig();
    });
    
    async function loadConfig() {
        try {
            const response = await fetch('/api/config');
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to load configuration');
            }
            
            currentConfig = data;
            displayConfig(data);
            displayMqttConfig(data);
            displayAppSettings(data);
        } catch (error) {
            console.error('Error loading configuration:', error);
            document.getElementById('configContainer').innerHTML = `
                <div class="alert alert-danger">
                    <i class="bi bi-exclamation-triangle-fill me-2"></i>
                    Failed to load configuration
                </div>
            `;
        }
    }
    
    function displayConfig(config) {
        const container = document.getElementById('configContainer');
        
        const html = `
            <div class="mb-3">
                <span class="config-label">InfluxDB URL</span>
                <div class="config-value font-monospace">${escapeHtml(config.influxdb_url)}</div>
            </div>
            <div class="mb-3">
                <span class="config-label">Organization</span>
                <div class="config-value">${escapeHtml(config.influxdb_org)}</div>
            </div>
            <div class="mb-3">
                <span class="config-label">Bucket</span>
                <div class="config-value">${escapeHtml(config.influxdb_bucket)}</div>
            </div>
            <div class="mb-3">
                <span class="config-label">Token</span>
                <div class="config-value">${config.influxdb_token ? '••••••••' : '<span class="text-warning">Not set</span>'}</div>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    function displayMqttConfig(config) {
        const container = document.getElementById('mqttConfigContainer');
        
        const html = `
            <div class="mb-3">
                <span class="config-label">Broker</span>
                <div class="config-value">${config.mqtt_broker ? escapeHtml(config.mqtt_broker) + ':' + config.mqtt_port : '<span class="text-secondary small">Not configured</span>'}</div>
            </div>
            <div class="mb-3">
                <span class="config-label">Username</span>
                <div class="config-value">${config.mqtt_user ? escapeHtml(config.mqtt_user) : '<span class="text-secondary small">None</span>'}</div>
            </div>
            <div class="mb-3">
                <span class="config-label">Discovery Prefix</span>
                <div class="config-value font-monospace">${escapeHtml(config.mqtt_discovery_prefix)}</div>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    function displayAppSettings(config) {
        const container = document.getElementById('appSettingsContainer');
        
        const html = `
            <div class="mb-3">
                <span class="config-label">Poll Interval</span>
                <div class="config-value">${config.poll_interval} minutes</div>
            </div>
            <div class="mb-3">
                <span class="config-label">Cron Schedule</span>
                <div class="config-value">${config.cron_schedule || '<span class="text-secondary small">Not set (using interval)</span>'}</div>
            </div>
            <div class="mb-3">
                <span class="config-label">Timezone</span>
                <div class="config-value">${config.timezone}</div>
            </div>
            <div class="mb-3">
                <span class="config-label">Log Level</span>
                <div class="config-value">${config.log_level}</div>
            </div>
        `;
        
        container.innerHTML = html;
    }
    
    function editInfluxConfig() {
        const container = document.getElementById('configContainer');
        
        const html = `
            <form id="influxConfigForm" onsubmit="saveInfluxConfig(event)">
                <div class="mb-3">
                    <label for="influxdb_url" class="form-label">InfluxDB URL</label>
                    <input type="text" class="form-control" id="influxdb_url" 
                           value="${escapeHtml(currentConfig.influxdb_url)}" required>
                </div>
                <div class="mb-3">
                    <label for="influxdb_org" class="form-label">Organization</label>
                    <input type="text" class="form-control" id="influxdb_org" 
                           value="${escapeHtml(currentConfig.influxdb_org)}" required>
                </div>
                <div class="mb-3">
                    <label for="influxdb_bucket" class="form-label">Bucket</label>
                    <input type="text" class="form-control" id="influxdb_bucket" 
                           value="${escapeHtml(currentConfig.influxdb_bucket)}" required>
                </div>
                <div class="mb-3">
                    <label for="influxdb_token" class="form-label">Token</label>
                    <input type="password" class="form-control" id="influxdb_token" 
                           placeholder="Enter new token or leave unchanged">
                    <small class="text-secondary">Leave blank to keep current token</small>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg"></i> Save
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="cancelInfluxEdit()">
                        <i class="bi bi-x-lg"></i> Cancel
                    </button>
                </div>
            </form>
        `;
        
        container.innerHTML = html;
        document.getElementById('editInfluxBtn').style.display = 'none';
    }
    
    function cancelInfluxEdit() {
        displayConfig(currentConfig);
        document.getElementById('editInfluxBtn').style.display = 'block';
    }
    
    function editMqttConfig() {
        const container = document.getElementById('mqttConfigContainer');
        
        const html = `
            <form id="mqttConfigForm" onsubmit="saveMqttConfig(event)">
                <div class="mb-3">
                    <label for="mqtt_broker" class="form-label">MQTT Broker</label>
                    <input type="text" class="form-control" id="mqtt_broker" 
                           value="${escapeHtml(currentConfig.mqtt_broker || '')}" placeholder="e.g. 192.168.1.100">
                </div>
                <div class="mb-3">
                    <label for="mqtt_port" class="form-label">Port</label>
                    <input type="number" class="form-control" id="mqtt_port" 
                           value="${currentConfig.mqtt_port || 1883}" required>
                </div>
                <div class="mb-3">
                    <label for="mqtt_user" class="form-label">Username</label>
                    <input type="text" class="form-control" id="mqtt_user" 
                           value="${escapeHtml(currentConfig.mqtt_user || '')}">
                </div>
                <div class="mb-3">
                    <label for="mqtt_password" class="form-label">Password</label>
                    <input type="password" class="form-control" id="mqtt_password" 
                           placeholder="Enter new password or leave blank">
                </div>
                <div class="mb-3">
                    <label for="mqtt_discovery_prefix" class="form-label">Discovery Prefix</label>
                    <input type="text" class="form-control" id="mqtt_discovery_prefix" 
                           value="${escapeHtml(currentConfig.mqtt_discovery_prefix || 'homeassistant')}" required>
                    <small class="text-secondary">Prefix for Home Assistant Auto Discovery</small>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg"></i> Save
                    </button>
                    <button type="button" class="btn btn-info" onclick="testMqttConnection()">
                        <i class="bi bi-lightning-fill"></i> Test Connection
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="cancelMqttEdit()">
                        <i class="bi bi-x-lg"></i> Cancel
                    </button>
                </div>
            </form>
        `;
        
        container.innerHTML = html;
        document.getElementById('editMqttBtn').style.display = 'none';
    }
    
    function cancelMqttEdit() {
        displayMqttConfig(currentConfig);
        document.getElementById('editMqttBtn').style.display = 'block';
    }
    
    async function saveMqttConfig(event) {
        event.preventDefault();
        
        const formData = {
            mqtt_broker: document.getElementById('mqtt_broker').value,
            mqtt_port: parseInt(document.getElementById('mqtt_port').value),
            mqtt_user: document.getElementById('mqtt_user').value,
            mqtt_password: document.getElementById('mqtt_password').value,
            mqtt_discovery_prefix: document.getElementById('mqtt_discovery_prefix').value
        };
        
        try {
            const response = await fetch('/api/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to save configuration');
            }
            
            showToast('MQTT configuration saved successfully', 'success');
            await loadConfig();
            document.getElementById('editMqttBtn').style.display = 'block';
        } catch (error) {
            console.error('Error saving MQTT configuration:', error);
            showToast(error.message, 'error');
        }
    }

    async function testMqttConnection() {
        const btn = document.querySelector('button[onclick="testMqttConnection()"]');
        const originalText = btn.innerHTML;
        
        const formData = {
            mqtt_broker: document.getElementById('mqtt_broker').value,
            mqtt_port: parseInt(document.getElementById('mqtt_port').value),
            mqtt_user: document.getElementById('mqtt_user').value,
            mqtt_password: document.getElementById('mqtt_password').value
        };
        
        try {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Testing...';
            btn.disabled = true;
            
            const response = await fetch('/api/config/mqtt/test', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Connection failed');
            }
            
            showToast(data.message, 'success');
        } catch (error) {
            console.error('MQTT Test Error:', error);
            showToast(error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }
    
    async function saveInfluxConfig(event) {
        event.preventDefault();
        
        const formData = {
            influxdb_url: document.getElementById('influxdb_url').value,
            influxdb_org: document.getElementById('influxdb_org').value,
            influxdb_bucket: document.getElementById('influxdb_bucket').value,
            influxdb_token: document.getElementById('influxdb_token').value
        };
        
        try {
            const response = await fetch('/api/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to save configuration');
            }
            
            showToast('Configuration saved successfully', 'success');
            await loadConfig();
            document.getElementById('editInfluxBtn').style.display = 'block';
        } catch (error) {
            console.error('Error saving configuration:', error);
            showToast(error.message, 'error');
        }
    }
    
    function editAppSettings() {
        const container = document.getElementById('appSettingsContainer');
        
        const html = `
            <form id="appSettingsForm" onsubmit="saveAppSettings(event)">
                <div class="mb-3">
                    <label for="poll_interval" class="form-label">Poll Interval (minutes)</label>
                    <input type="number" class="form-control" id="poll_interval" 
                           value="${currentConfig.poll_interval}" min="1" required>
                    <small class="text-secondary">Used if Cron Schedule is empty</small>
                </div>
                <div class="mb-3">
                    <label for="cron_schedule" class="form-label">Cron Schedule</label>
                    <input type="text" class="form-control" id="cron_schedule" 
                           value="${currentConfig.cron_schedule || ''}" placeholder="e.g. 0 */1 * * *">
                    <small class="text-secondary">Standard Cron format. Overrides Poll Interval.</small>
                </div>
                <div class="mb-3">
                    <label for="timezone" class="form-label">Timezone</label>
                    <input type="text" class="form-control" id="timezone" 
                           value="${currentConfig.timezone}" required>
                    <small class="text-secondary">e.g. Australia/Sydney</small>
                </div>
                <div class="mb-3">
                    <label for="log_level" class="form-label">Log Level</label>
                    <select class="form-select" id="log_level" required>
                        <option value="DEBUG" ${currentConfig.log_level === 'DEBUG' ? 'selected' : ''}>DEBUG</option>
                        <option value="INFO" ${currentConfig.log_level === 'INFO' ? 'selected' : ''}>INFO</option>
                        <option value="WARNING" ${currentConfig.log_level === 'WARNING' ? 'selected' : ''}>WARNING</option>
                        <option value="ERROR" ${currentConfig.log_level === 'ERROR' ? 'selected' : ''}>ERROR</option>
                        <option value="CRITICAL" ${currentConfig.log_level === 'CRITICAL' ? 'selected' : ''}>CRITICAL</option>
                    </select>
                </div>
                <div class="d-flex gap-2">
                    <button type="submit" class="btn btn-success">
                        <i class="bi bi-check-lg"></i> Save
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="cancelAppEdit()">
                        <i class="bi bi-x-lg"></i> Cancel
                    </button>
                </div>
            </form>
        `;
        
        container.innerHTML = html;
        document.getElementById('editAppBtn').style.display = 'none';
    }
    
    function cancelAppEdit() {
        displayAppSettings(currentConfig);
        document.getElementById('editAppBtn').style.display = 'block';
    }
    
    async function saveAppSettings(event) {
        event.preventDefault();
        
        const formData = {
            poll_interval: parseInt(document.getElementById('poll_interval').value),
            cron_schedule: document.getElementById('cron_schedule').value,
            timezone: document.getElementById('timezone').value,
            log_level: document.getElementById('log_level').value
        };
        
        try {
            const response = await fetch('/api/config', {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(formData)
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to save settings');
            }
            
            showToast('Settings saved successfully', 'success');
            await loadConfig();
            document.getElementById('editAppBtn').style.display = 'block';
        } catch (error) {
            console.error('Error saving settings:', error);
            showToast(error.message, 'error');
        }
    }

    async function generateHACard() {
        const fuelType = document.getElementById('haFuelType').value;
        const btn = document.querySelector('button[onclick="generateHACard()"]');
        const originalText = btn.innerHTML;
        
        try {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span>';
            btn.disabled = true;
            
            const response = await fetch('/api/ha/generate-card', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ fuel_type: fuelType })
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Failed to generate card');
            }
            
            document.getElementById('haCardOutput').value = data.yaml;
            document.getElementById('haCardResult').style.display = 'block';
            
        } catch (error) {
            console.error('Error generating card:', error);
            showToast(error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    function copyHACard() {
        const copyText = document.getElementById("haCardOutput");
        copyText.select();
        copyText.setSelectionRange(0, 99999); // For mobile devices
        
        // Try modern API
        if (navigator.clipboard && window.isSecureContext) {
            navigator.clipboard.writeText(copyText.value).then(() => {
                showToast('Copied to clipboard', 'success');
            }).catch(err => {
                console.error('Failed to copy: ', err);
                fallbackCopy(copyText);
            });
        } else {
            fallbackCopy(copyText);
        }
    }
    
    function fallbackCopy(element) {
        try {
            document.execCommand('copy');
            showToast('Copied to clipboard', 'success');
        } catch (err) {
            console.error('Fallback copy failed: ', err);
            showToast('Failed to copy. Please copy manually.', 'error');
        }
    }
    
    function escapeHtml(text) {
        const map = {
            '&': '&amp;',
            '<': '&lt;',
            '>': '&gt;',
            '"': '&quot;',
            "'": '&#039;'
        };
        return text.replace(/[&<>"']/g, m => map[m]);
    }

    async function createBackup() {
        const btn = document.getElementById('backupBtn');
        const originalText = btn.innerHTML;
        
        try {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Creating...';
            btn.disabled = true;
            
            const response = await fetch('/api/backup', { method: 'POST' });
            
            if (!response.ok) {
                const data = await response.json();
                throw new Error(data.error || 'Backup failed');
            }
            
            // Trigger download
            const blob = await response.blob();
            const url = window.URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = response.headers.get('Content-Disposition').split('filename=')[1].replace(/"/g, '');
            document.body.appendChild(a);
            a.click();
            window.URL.revokeObjectURL(url);
            document.body.removeChild(a);
            
            showToast('Backup created successfully', 'success');
        } catch (error) {
            console.error('Backup error:', error);
            showToast(error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
        }
    }

    async function restoreBackup(input) {
        if (!input.files || !input.files[0]) return;
        
        const file = input.files[0];
        const btn = document.getElementById('restoreBtn');
        const originalText = btn.innerHTML;
        
        if (!confirm('WARNING: Restoring a backup might overwrite existing data. Are you sure?')) {
            input.value = '';
            return;
        }
        
        try {
            btn.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Restoring...';
            btn.disabled = true;
            
            const formData = new FormData();
            formData.append('file', file);
            
            const response = await fetch('/api/restore', {
                method: 'POST',
                body: formData
            });
            
            const data = await response.json();
            
            if (!response.ok) {
                throw new Error(data.error || 'Restore failed');
            }
            
            showToast('Backup restored successfully', 'success');
        } catch (error) {
            console.error('Restore error:', error);
            showToast(error.message, 'error');
        } finally {
            btn.innerHTML = originalText;
            btn.disabled = false;
            input.value = '';
        }
    }
</script>
{% endblock %}